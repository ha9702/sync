sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,o){"use strict";return e.extend("sync.zec.sales1.controller.Summary",{onInit:function(){var e=this.getOwnerComponent().getModel("cart");var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("RouteSummary").attachPatternMatched(this._onPatternMatched,this);e.attachRequestCompleted(function(){this._onDataLoaded()}.bind(this));this.getView().setModel(e,"cart")},_onDataLoaded:function(){console.log("Data loaded successfully")},_onPatternMatched:function(){var e=this.getOwnerComponent().getModel("cart");var t=e.getProperty("/summaryData");if(!t){console.error("Summary data is missing!");return}},_navBackToStep:function(e){var t=e.getSource();var o=t.data("navBackTo");var a=sap.ui.core.UIComponent.getRouterFor(this);var n=this.getOwnerComponent().getModel("cart");a.navTo("RoutePayment",{cartItems:encodeURIComponent(JSON.stringify(n.getProperty("/cartItems"))),stepId:o})},handleWizardCancel:function(){t.confirm("Are you sure you want to cancel the order?",{title:"Cancel Order",actions:[t.Action.OK,t.Action.CANCEL],onClose:function(e){if(e===t.Action.OK){var o=sap.ui.core.UIComponent.getRouterFor(this);var a=this.getOwnerComponent().getModel("cart");o.navTo("RouteHome")}}.bind(this)})},handleWizardSubmit:function(){var e=this.getOwnerComponent().getModel("cart");var o=e.getProperty("/summaryData/selectedPaymentType");t.confirm("결제를 진행하시겠습니까?",{title:"결제 확인창",actions:[t.Action.OK,t.Action.CANCEL],onClose:function(a){if(a===t.Action.OK){var n=this._prepareSummaryData(e);localStorage.setItem("summaryData",JSON.stringify(n));if(o==="KakaoPay"){this._callKakaoPayAPI(n)}else if(o==="Card"){this._createEntityAndNavigateToSuccess()}}}.bind(this)})},_prepareSummaryData:function(e){var t=e.getProperty("/cartItems");console.log(e);var o={Vbeln:"",Kunnr:"CUS9999999",Subcmon:e.oData.Submonth.toString(),toItem:t.map(function(e){return{Matnr:e.Matnr,Netpr:parseFloat(e.Netpr).toFixed(2),Menge:parseFloat(e.Quantity).toFixed(2)}})};console.log(o);return o},_callKakaoPayAPI:function(e){console.log("Calling KakaoPay API with data:",e);$.ajax({url:"http://localhost:3000/pay",method:"POST",contentType:"application/json",data:JSON.stringify({amount:e.toItem.reduce(function(e,t){return e+parseFloat(t.Netpr)*parseFloat(t.Menge)},0),item_name:"SSP 영양제"}),success:function(e){console.log("KakaoPay API response:",e);if(e.next_redirect_pc_url){this._openPopup(e.next_redirect_pc_url)}else{sap.m.MessageBox.error("Failed to initiate KakaoPay payment.")}}.bind(this),error:function(e){console.error("Error during KakaoPay API call:",e);sap.m.MessageBox.error("Payment initiation failed: "+e.responseText)}})},_openPopup:function(e){var t=window.open(e,"KakaoPayPopup","width=500,height=600");var o=setInterval(function(){if(t.closed){clearInterval(o);this._handlePopupClose()}}.bind(this),500)},_handlePopupClose:function(){console.log("Popup closed");this._createEntityAndNavigateToSuccess()},_createEntityAndNavigateToSuccess:function(){var e=JSON.parse(localStorage.getItem("summaryData"));if(e){console.log("Creating entity with data:",e);var t=this.getOwnerComponent().getModel();var o=this.getView();o.setModel(t);t.create("/SalesHeaderSet",e,{success:function(e){console.log("Sales order created successfully:",e);var t=this.getOwnerComponent().getModel("cart");t.setProperty("/Vbeln",e.Vbeln);t.setProperty("/Amount",e.Amount*100);var o=sap.ui.core.UIComponent.getRouterFor(this);o.navTo("RouteSuccess")}.bind(this),error:function(e){console.error("Error creating sales order:",e);sap.m.MessageBox.error("Order creation failed: "+e.responseText)}})}else{console.error("Invalid order information.")}}})});
//# sourceMappingURL=Summary.controller.js.map