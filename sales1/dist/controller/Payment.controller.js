sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/ValidateException"],function(e,t,a,r){"use strict";return e.extend("sync.zec.sales1.controller.Payment",{onInit:function(){var e=this.getOwnerComponent().getModel("cart");this.getView().setModel(e);var t=sap.ui.core.UIComponent.getRouterFor(this);var a=t.getRoute("RoutePayment");if(a){a.attachPatternMatched(this._onPatternMatched,this)}var r=t.getRoute("RouteSummary");if(r){r.attachPatternMatched(this._onSummaryPatternMatched,this)}e.setProperty("/cardOwner","");e.setProperty("/cardNumber","");e.setProperty("/cvc","");e.setProperty("/expiryDate","");e.setProperty("/selectedPaymentType","Card");e.setProperty("/paymentTypeSelected",false);e.setProperty("/isCardInfoValid",false);this._loadDaumPostcodeScript().then(()=>{console.log("Daum Postcode script loaded successfully")}).catch(e=>{console.error("Failed to load Daum Postcode script:",e)})},_onSummaryPatternMatched:function(e){},_onPatternMatched:function(e){var t=e.getParameter("arguments").cartItems;var a=JSON.parse(decodeURIComponent(t));var r=e.getParameter("arguments").sourceView;var o=this.getView().getModel("cart");o.setProperty("/cartItems",a);o.setProperty("/sourceView",r);var i=e.getParameter("arguments").stepId;if(i){this._goToStep(i)}},_goToStep:function(e){var t=this.byId("paymentWizard");var a=this.byId(e);if(a){t.discardProgress(a);t.goToStep(a)}},onPaymentTypeSelect:function(e){this.setPaymentMethod(e)},onNextStep:function(e){var t=this.byId("paymentWizard");t.nextStep();var a=e.getSource();var r=a.getId();if(a){a.setVisible(false)}},onNavBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=this.getView().getModel("cart");var a=t.getProperty("/sourceView");var r=t.oData.Before;console.log(r);if(r==="home"){e.navTo("RouteHome")}else if(r==="sub"){e.navTo("RouteSub")}else{e.navTo("RouteHome")}},validateCardInfo:function(){var e=this.getView();var t=e.byId("creditCardHolderName").getValueState()==="None"&&e.byId("creditCardHolderName").getValue().trim()!==""&&e.byId("creditCardNumber").getValueState()==="None"&&e.byId("creditCardNumber").getValue().trim()!==""&&e.byId("creditCardSecurityNumber").getValueState()==="None"&&e.byId("creditCardSecurityNumber").getValue().trim()!==""&&e.byId("creditCardExpirationDate").getValueState()==="None"&&e.byId("creditCardExpirationDate").getValue().trim()!=="";this.getView().getModel("cart").setProperty("/isCardInfoValid",t)},checkCardHolderName:function(e){var t=e.getSource();var a=t.getValue();var r=/^[a-zA-Z가-힣]+$/;if(a.length>=2&&r.test(a)){t.setValueState("None")}else{t.setValueState("Error")}this.validateCardInfo()},checkCardNumber:function(e){var t=e.getSource();var a=t.getValue();var r=/^[0-9-]+$/;var o=a.length===19&&r.test(a);if(o){t.setValueState("None")}else{t.setValueState("Error");t.setValueStateText("유효한 카드번호를 입력해주세요.")}this.validateCardInfo()},checkSecurityCode:function(e){var t=e.getSource();var a=t.getValue();var r=/^[0-9]{3}$/;var o=r.test(a);if(o){t.setValueState("None")}else{t.setValueState("Error");t.setValueStateText("3자리의 숫자만 입력해주세요.")}this.validateCardInfo()},checkExpirationDate:function(e){var t=e.getSource();var a=t.getValue();var r=/^(0[1-9]|1[0-2])\/\d{4}$/.test(a);if(!r){t.setValueState("Error");t.setValueStateText("유효한 날짜를 입력해주세요.");return}var o=a.split("/");var i=parseInt(o[0],10);var s=parseInt(o[1],10);var d=new Date;var n=d.getMonth()+1;var c=d.getFullYear();if(s<c||s===c&&i<n){t.setValueState("Error");t.setValueStateText("유효기간이 만료되었습니다.")}else{t.setValueState("None")}this.validateCardInfo()},_loadDaumPostcodeScript:function(){return new Promise((e,t)=>{if(typeof daum!=="undefined"){e();return}var a=document.createElement("script");a.src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";a.onload=()=>{console.log("Daum Postcode script loaded");e()};a.onerror=()=>{console.error("Failed to load Daum Postcode script");t(new Error("Failed to load Daum Postcode script"))};document.head.appendChild(a)})},onFindAddress:function(){console.log("onFindAddress 호출됨");if(typeof daum==="undefined"){console.error("Daum Postcode API 스크립트가 로드되지 않았습니다.");return}new daum.Postcode({oncomplete:function(e){console.log("API 호출 후 데이터 반환: ",e);var t="";var a="";if(e.userSelectedType==="R"){t=e.roadAddress}else{t=e.jibunAddress}if(e.userSelectedType==="R"){if(e.bname!==""&&/[동|로|가]$/g.test(e.bname)){a+=e.bname}if(e.buildingName!==""&&e.apartment==="Y"){a+=a!==""?", "+e.buildingName:e.buildingName}if(a!==""){a=" ("+a+")"}this.getView().byId("idExtraAddress").setValue(a)}else{this.getView().byId("idExtraAddress").setValue("")}this.getView().byId("idPostcode").setValue(e.zonecode);this.getView().byId("idAddress").setValue(t);this.getView().byId("idDetailAddress").focus()}.bind(this)}).open()},onCheck:function(){var e=this.getView().getModel("cart");var t=sap.ui.core.UIComponent.getRouterFor(this);var a={cartItems:e.getProperty("/cartItems"),selectedPaymentType:e.getProperty("/SelectedPayment"),cardOwner:e.getProperty("/cardOwner"),cardNumber:e.getProperty("/cardNumber"),cvc:e.getProperty("/cvc"),expiryDate:e.getProperty("/expiryDate"),totalPrice:e.getProperty("/totalPrice"),deliveryAddress:{postcode:this.getView().byId("idPostcode").getValue(),address:this.getView().byId("idAddress").getValue(),detailAddress:this.getView().byId("idDetailAddress").getValue(),extraAddress:this.getView().byId("idExtraAddress").getValue()}};e.setProperty("/summaryData",a);t.navTo("RouteSummary")},_calculateTotal:function(e){return e.reduce(function(e,t){return e+t.price*t.quantity},0)},onInputChange:function(){var e=this._checkAllInputFilled();this.getView().byId("checkButton").setEnabled(e)},_checkAllInputFilled:function(){var e=["idPostcode","idAddress","idDetailAddress","idExtraAddress"];return e.every(function(e){var t=this.getView().byId(e);return t&&t.getValue().trim()!==""},this)},goToPaymentStep:function(){var e=this.getView().getModel().getProperty("/SelectedPayment");var t=this.byId("paymentWizard");var a=this.byId("paymentTypeStep");switch(e){case"KakaoPay":a.setNextStep(this.byId("idDestination"));break;case"Card":default:a.setNextStep(this.byId("cardInfoStep"));break}},setPaymentMethod:function(e){var t=e.getParameter("key");var a=this.getView().getModel("cart");a.setProperty("/SelectedPayment",t);this._updateStepVisibility(t);this.goToPaymentStep()},_updateStepVisibility:function(e){var t=this.getView();t.byId("cardInfoStep").setVisible(false);t.byId("idDestination").setVisible(false);switch(e){case"KakaoPay":t.byId("idDestination").setVisible(true);t.byId("paymentTypeStep").setIcon("sap-icon://money-bills");t.byId("idDestination").setIcon("sap-icon://shipping-status");break;case"Card":default:t.byId("cardInfoStep").setVisible(true);t.byId("idDestination").setVisible(true);t.byId("paymentTypeStep").setIcon("sap-icon://money-bills");t.byId("cardInfoStep").setIcon("sap-icon://credit-card");t.byId("idDestination").setIcon("sap-icon://shipping-status");break}}})});
//# sourceMappingURL=Payment.controller.js.map